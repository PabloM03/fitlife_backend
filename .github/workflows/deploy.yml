name: ðŸš€ Deploy backend en Tomcat

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout + build
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      - uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: Build WAR
        run: |
          cd fitlife
          mvn -B clean package -DskipTests

      # 2) Deploy
      - name: Deploy to remote Tomcat
        env:
          SSH_KEY:     ${{ secrets.SERVER_SSH_KEY }}   # tu PEM completo
          SERVER_IP:   ${{ secrets.SERVER_IP }}        # 13.61.161.23
          SERVER_USER: ${{ secrets.SERVER_USER }}      # ubuntu
        run: |
          set -e

          # --- Arranca agent y carga la clave ---
          eval "$(ssh-agent -s)"
          printf '%s\n' "$SSH_KEY" | ssh-add -

          # --- Registra la huella del servidor ---
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts

          # --- Sube el WAR al home ---
          scp fitlife/target/fitlife.war "$SERVER_USER@$SERVER_IP:~/fitlife.war"

          # --- Mueve a Tomcat y reinicia ---
          ssh "$SERVER_USER@$SERVER_IP" << 'EOF'
            sudo mv ~/fitlife.war /opt/tomcat/webapps/ROOT.war
            sudo systemctl restart tomcat
          EOF
